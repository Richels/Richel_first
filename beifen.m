clear all;
clc;
tic
format long
%关于变量 x,u 取了7个基函数，从0开始，所以N取到6
N=6;
%关于约束系数取了7个基函数，从0开始，所以M取到6
M=6;

% %输入初始值
% %mu_0的初始值
mu0=[16.15,-17.55,14.63,-9.46,7.82,-5.88,5.26,-334,-1456,-5763,-25231,120.26,378.02,-38.03]';
% % xx=rand(1,N+M+2);yy=sum(xx);
% % mu0=xx/yy;
% mu0=zeros(1,N+M+2);
% mu0(1,2)=1.5;
% mu0(1,1)=-0.5;
% mu0(1,3)=0.9;
% mu0(1,7)=0.2;
% % mu0=zeros(N+M+2,1);
% %对应的ab_0的初始值
% ab0=zeros(1,N+M+2);
% ab0(1,2)=2;
% ab0(1,1)=1;
% ab0(1,3)=1/2;
ab0=[1.65,-0.71,0.53,-0.11,1,3,2,-5.20,7.02,-3.40,0.74,-0.22,0.06,1];
%%接下来输入相关的系数矩阵
%首先输入大C
C1=zeros(N+M+1,N+1);
abb=[ab0(1,1:N+1),zeros(1,M)];
for i=1:N+M+1
    for j=1:N+1
        if i==j
            C1(i,j)=abb(1);
        elseif i>j
            C1(i,j)=abb(i-j+1);
        else
            C1(i,j)=0;
        end
    end
end

C2=zeros(N+M+1,N+1);
for i=1:N+M+1
    for j=1:N+1
        if i==j
            C2(i,j)=abb(1);
        elseif i<j
            C2(i,j)=abb(j-i+1);
        else
            C2(i,j)=0;
        end
    end
end

C3=zeros(N+M+1,N+1);
for i=2:N+M+1
    for j=1:N+1
        if (i+j)<=(M+2)
            C3(i,j)=abb(j+i-1);
        else
            C3(i,j)=0;
        end
    end
end

C=C1+C2+C3;

D11=1/2*eye(N+1);
D12=zeros(M,N+1);
D1=[D11;D12];

D2=D1;

D3=zeros(N+M+1,N+1);

D=D1+D2+D3;

%接下来输入小c，为了防止看混淆，用cc代替
%因为cc是等于-x^2,所以直接用-（a*T）*(a*T)代替
C11=zeros(N+M+1,N+1);
abb=[ab0(1,1:N+1),zeros(1,M)];
for i=1:N+M+1
    for j=1:N+1
        if i==j
            C11(i,j)=1/2*abb(1);
        elseif i>j
            C11(i,j)=1/2*abb(i-j+1);
        else
            C11(i,j)=0;
        end
    end
end

C22=zeros(N+M+1,N+1);
for i=1:N+M+1
    for j=1:N+1
        if i==j
            C22(i,j)=1/2*abb(1);
        elseif i<j
            C22(i,j)=1/2*abb(j-i+1);
        else
            C22(i,j)=0;
        end
    end
end

C33=zeros(N+M+1,N+1);
for i=2:N+M+1
    for j=1:N+1
        if (i+j)<=(M+2)
            C33(i,j)=1/2*abb(j+i-1);
        else
            C33(i,j)=0;
        end
    end
end

CC=C11+C22+C33;

abbbb=ab0(1,1:N+1);
cc=-CC*abbbb';

%输入矩阵E
E=zeros(N+M+1,N+1);
for i=1:N
    for j=2:N+1
        if i==j-1
            E(i,j)=i;
        end
    end
end

%输入矩阵F
F=zeros(N+M+1,N+M+1);
for i=1:N+M+1
    for j=1:N+M+1
        if i==j
            F(i,j)=1;
        elseif j==i+2
            F(i,j)=-1;
        end
    end
end
F(1,1)=2;
F=1/4*F;

%构造系数矩阵H、向量h
%这里涉及到3和Boundary是因为原问题有个约束x(0)=3;
%Boundary代表着约束：a0*T0(-1)+a1*T1(-1)+……+a6*T6(-1)=3 的系数
Boundary=zeros(1,2*N+2);
for i=1:N+1
    if mod(i,2)==0
        Boundary(i)=-1;
    else
        Boundary(i)=1;
    end
end
H=[F*C-E F*D;Boundary];

h=-1*F*cc;
h=[-1*F*cc;3];

%求区间[-1,1]上矩阵TT*矩阵T的积分
ff=@(s)([2*1,2*s,2*(2*s.^2-1),2*(4*s.^3-3*s),2*(8*s.^4-8*s.^2+1),2*(16*s.^5-20*s.^3+5*s),2*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*s*1,2*s.*s,2*s.*(2*s.^2-1),2*s.*(4*s.^3-3*s),2*s.*(8*s.^4-8*s.^2+1),2*s.*(16*s.^5-20*s.^3+5*s),2*s.*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*(2*s.^2-1)*1,2*(2*s.^2-1).*s,2*(2*s.^2-1).*(2*s.^2-1),2*(2*s.^2-1).*(4*s.^3-3*s),2*(2*s.^2-1).*(8*s.^4-8*s.^2+1),2*(2*s.^2-1).*(16*s.^5-20*s.^3+5*s),2*(2*s.^2-1).*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*(4*s.^3-3*s).*1,2*(4*s.^3-3*s).*s,2*(4*s.^3-3*s).*(2*s.^2-1),2*(4*s.^3-3*s).*(4*s.^3-3*s),2*(4*s.^3-3*s).*(8*s.^4-8*s.^2+1),2*(4*s.^3-3*s).*(16*s.^5-20*s.^3+5*s),2*(4*s.^3-3*s).*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*(8*s.^4-8*s.^2+1).*1,2*(8*s.^4-8*s.^2+1).*s,2*(8*s.^4-8*s.^2+1).*(2*s.^2-1),2*(8*s.^4-8*s.^2+1).*(4*s.^3-3*s),2*(8*s.^4-8*s.^2+1).*(8*s.^4-8*s.^2+1),2*(8*s.^4-8*s.^2+1).*(16*s.^5-20*s.^3+5*s),2*(8*s.^4-8*s.^2+1).*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*(16*s.^5-20*s.^3+5*s).*1,2*(16*s.^5-20*s.^3+5*s).*s,2*(16*s.^5-20*s.^3+5*s).*(2*s.^2-1),2*(16*s.^5-20*s.^3+5*s).*(4*s.^3-3*s),2*(16*s.^5-20*s.^3+5*s).*(8*s.^4-8*s.^2+1),2*(16*s.^5-20*s.^3+5*s).*(16*s.^5-20*s.^3+5*s),2*(16*s.^5-20*s.^3+5*s).*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    2*(32*s.^6-48*s.^4+18*s.^2-1).*1,2*(32*s.^6-48*s.^4+18*s.^2-1).*s,2*(32*s.^6-48*s.^4+18*s.^2-1).*(2*s.^2-1),2*(32*s.^6-48*s.^4+18*s.^2-1).*(4*s.^3-3*s),2*(32*s.^6-48*s.^4+18*s.^2-1).*(8*s.^4-8*s.^2+1),2*(32*s.^6-48*s.^4+18*s.^2-1).*(16*s.^5-20*s.^3+5*s),2*(32*s.^6-48*s.^4+18*s.^2-1).*(32*s.^6-48*s.^4+18*s.^2-1),zeros(1,N+1);
    zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1;
    zeros(1,N+1),1*s,s.*s,s.*(2*s.^2-1),s.*(4*s.^3-3*s),s.*(8*s.^4-8*s.^2+1),s.*(16*s.^5-20*s.^3+5*s),s.*(32*s.^6-48*s.^4+18*s.^2-1);
    zeros(1,N+1),(2*s.^2-1).*1,(2*s.^2-1).*s,(2*s.^2-1).*(2*s.^2-1),(2*s.^2-1).*(4*s.^3-3*s),(2*s.^2-1).*(8*s.^4-8*s.^2+1),(2*s.^2-1).*(16*s.^5-20*s.^3+5*s),(2*s.^2-1).*(32*s.^6-48*s.^4+18*s.^2-1);
    zeros(1,N+1),(4*s.^3-3*s).*1,(4*s.^3-3*s).*s,(4*s.^3-3*s).*(2*s.^2-1),(4*s.^3-3*s).*(4*s.^3-3*s),(4*s.^3-3*s).*(8*s.^4-8*s.^2+1),(4*s.^3-3*s).*(16*s.^5-20*s.^3+5*s),(4*s.^3-3*s).*(32*s.^6-48*s.^4+18*s.^2-1);
    zeros(1,N+1),(8*s.^4-8*s.^2+1).*1,(8*s.^4-8*s.^2+1).*s,(8*s.^4-8*s.^2+1).*(2*s.^2-1),(8*s.^4-8*s.^2+1).*(4*s.^3-3*s),(8*s.^4-8*s.^2+1).*(8*s.^4-8*s.^2+1),(8*s.^4-8*s.^2+1).*(16*s.^5-20*s.^3+5*s),(8*s.^4-8*s.^2+1).*(32*s.^6-48*s.^4+18*s.^2-1);
    zeros(1,N+1),(16*s.^5-20*s.^3+5*s).*1,(16*s.^5-20*s.^3+5*s).*s,(16*s.^5-20*s.^3+5*s).*(2*s.^2-1),(16*s.^5-20*s.^3+5*s).*(4*s.^3-3*s),(16*s.^5-20*s.^3+5*s).*(8*s.^4-8*s.^2+1),(16*s.^5-20*s.^3+5*s).*(16*s.^5-20*s.^3+5*s),(16*s.^5-20*s.^3+5*s).*(32*s.^6-48*s.^4+18*s.^2-1);
    zeros(1,N+1),(32*s.^6-48*s.^4+18*s.^2-1).*1,(32*s.^6-48*s.^4+18*s.^2-1).*s,(32*s.^6-48*s.^4+18*s.^2-1).*(2*s.^2-1),(32*s.^6-48*s.^4+18*s.^2-1).*(4*s.^3-3*s),(32*s.^6-48*s.^4+18*s.^2-1).*(8*s.^4-8*s.^2+1),(32*s.^6-48*s.^4+18*s.^2-1).*(16*s.^5-20*s.^3+5*s),(32*s.^6-48*s.^4+18*s.^2-1).*(32*s.^6-48*s.^4+18*s.^2-1)]);
TTT_integral=integral(ff,-1,1,'RelTol',1e-12,'ArrayValued',true);
%积分后求逆
y=inv(TTT_integral);

%输入fmincon相关的命令

G=H*y*H';

Hy=H*y;

fff=@(s)([Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2,Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'*2]*[[Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'].*eye(N+M+2)]);
%
%
%
%
%
WW=integral(fff,-1,1,'RelTol',1e-12,'ArrayValued',true);
WW=WW';


ffff=@(s)([Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]']*[[Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]'].*eye(N+M+2)]);


PP=integral(ffff,-1,1,'RelTol',1e-12,'ArrayValued',true);
PP=PP';
WP=WW+PP;

GWP=WP-G-G';
mu=inv(GWP)*h;
falll=obj(mu,h,H,N,y);
%迭代停止条件为||mu_{k+1}-mu_k||  <  epsilon
dk=mu-mu0;
dk_norm=norm(dk);
%%
%开始循环,epsilon取10^{-8}
while dk_norm>1e-4
    mu0=mu;
    %每次的矩阵C需要更新、cc（小c）需要更新、矩阵D、F、E是常数矩阵，不需要更新
    %接下来更新矩阵C
    ab0=(-mu0')*H*y;
    C1=zeros(N+M+1,N+1);
    abb=[ab0(1,1:N+1),zeros(1,M)];
    for i=1:N+M+1
        for j=1:N+1
            if i==j
                C1(i,j)=abb(1);
            elseif i>j
                C1(i,j)=abb(i-j+1);
            else
                C1(i,j)=0;
            end
        end
    end
    
    C2=zeros(N+M+1,N+1);
    for i=1:N+M+1
        for j=1:N+1
            if i==j
                C2(i,j)=abb(1);
            elseif i<j
                C2(i,j)=abb(j-i+1);
            else
                C2(i,j)=0;
            end
        end
    end
    
    C3=zeros(N+M+1,N+1);
    for i=2:N+M+1
        for j=1:N+1
            if (i+j)<=(M+2)
                C3(i,j)=abb(j+i-1);
            else
                C3(i,j)=0;
            end
        end
    end
    
    C=C1+C2+C3;
    
    %接下来更新cc（即小c）
    C11=zeros(N+M+1,N+1);
    abb=[ab0(1,1:N+1),zeros(1,M)];
    for i=1:N+M+1
        for j=1:N+1
            if i==j
                C11(i,j)=1/2*abb(1);
            elseif i>j
                C11(i,j)=1/2*abb(i-j+1);
            else
                C11(i,j)=0;
            end
        end
    end
    
    C22=zeros(N+M+1,N+1);
    for i=1:N+M+1
        for j=1:N+1
            if i==j
                C22(i,j)=1/2*abb(1);
            elseif i<j
                C22(i,j)=1/2*abb(j-i+1);
            else
                C22(i,j)=0;
            end
        end
    end
    
    C33=zeros(N+M+1,N+1);
    for i=2:N+M+1
        for j=1:N+1
            if (i+j)<=(M+2)
                C33(i,j)=1/2*abb(j+i-1);
            else
                C33(i,j)=0;
            end
        end
    end
    
    CC=C11+C22+C33;
    
    abbbb=ab0(1,1:N+1);
    cc=-CC*abbbb';
    
    %从而得到更新后的H
    H=[F*C-E F*D;Boundary];
    %更新后的h
    h=-1*F*cc;
    h=[-1*F*cc;3];
    
   G=H*y*H';

Hy=H*y;

fff=@(s)([Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]']*[[Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]',Hy*[1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1,zeros(1,N+1)]'].*eye(N+M+2)]);
%
%
%
%
%
WW=integral(fff,-1,1,'RelTol',1e-12,'ArrayValued',true);
WW=2*WW';


ffff=@(s)([Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]']*[[Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]',Hy*[zeros(1,N+1),1,s,2*s.^2-1,4*s.^3-3*s,8*s.^4-8*s.^2+1,16*s.^5-20*s.^3+5*s,32*s.^6-48*s.^4+18*s.^2-1]'].*eye(N+M+2)]);


PP=integral(ffff,-1,1,'RelTol',1e-12,'ArrayValued',true);
PP=PP';
WP=WW+PP;

GWP=WP-G-G';
mu=inv(GWP)*h;
    %迭代停止条件为||mu_{k+1}-mu_k||  <  epsilon
    dk=mu-mu0;
    dk_norm=norm(dk);
end









%状态x的图像
% ss=-1:0.01:1;
% yy=ab(1)+ab(2)*ss+ab(3)*(2*ss.^2-1)+ab(4)*(4*ss.^3-3*ss)+ab(5)*(8*ss.^4-8*ss.^2+1)+ab(6)*(16*ss.^5-20*ss.^3+5*ss)+ab(7)*(32*ss.^6-48*ss.^4+18*ss.^2-1);
%  plot(ss,yy);
% 控制u的图像
% uu=-1:0.01:1;
% yyu=ab(8)+ab(9)*uu+ab(10)*(2*uu.^2-1)+ab(11)*(4*uu.^3-3*uu)+ab(12)*(8*uu.^4-8*uu.^2+1)+ab(13)*(16*uu.^5-20*uu.^3+5*uu)+ab(14)*(32*uu.^6-48*uu.^4+18*uu.^2-1);
% plot(uu,yyu);

% toc
% disp(['运行时间: ',num2str(toc)]);